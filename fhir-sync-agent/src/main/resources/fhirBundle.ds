local getAttrById(attr) = ds.filter(body.enrollments[0].attributes, function(v, i) v.attribute == attr)[0].value default null;
local getAttrByCode(attr) = ds.filter(body.enrollments[0].attributes, function(v, i) std.get(v, "code", "") == attr)[0].value default null;

local alternativeContact() = {
  [if getAttrByCode("ANC.A.DE10") != null then "name"]: getAttrByCode("ANC.A.DE10"),
  [if getAttrByCode("ANC.A.DE11") != null then "telecom"]: {
    "system": "phone",
    "value": getAttrByCode("ANC.A.DE11")
  }
};

local ancContact() = {
  [if getAttrByCode("ANC.A.DE12") != null then "telecom"]: {
    system: "phone",
    value: getAttrByCode("ANC.A.DE12")
  }
};

local extendedFamilyContact() = {
  name: {
    text: "Extended family"
  },
  relationship: [
    {
      coding: [
        {
          system : "http://terminology.hl7.org/CodeSystem/v3-RoleCode",
          code: "EXT",
          display: "extended family member"
        }
      ]
    }
  ]
};

local friendContact() = {
  relationship: [
    {
      coding: [
        {
          system : "http://terminology.hl7.org/CodeSystem/v3-RoleCode",
          code: "FRND",
          display: "friend"
        }
      ]
    }
  ]
};

local parentContact() = {
  relationship: [
    {
      coding: [
        {
          system : "http://terminology.hl7.org/CodeSystem/v3-RoleCode",
          code: "PRN",
          display: "parent"
        }
      ]
    }
  ]
};

local partnerContact() = {
  relationship: [
    {
      coding: [
        {
          system : "http://terminology.hl7.org/CodeSystem/v3-RoleCode",
          code: "DOMPART",
          display: "domestic partner"
        }
      ]
    }
  ]
};

local siblingContact() = {
  relationship: [
    {
      coding: [
        {
          system : "http://terminology.hl7.org/CodeSystem/v3-RoleCode",
          code: "SIB",
          display: "sibling"
        }
      ]
    }
  ]
};

{
  resourceType: "Bundle",
  type: "transaction",
  entry: [
    {
      fullUrl: "urn:uuid:ff991a8e-db1c-dfe2-e5b1-e411451eb602",
      resource: {
        resourceType : "Patient",
        meta : {
          profile : [
            "http://hl7.org/fhir/uv/ips/StructureDefinition/Patient-uv-ips"
          ]
        },
        identifier : [
          {
            system : "urn:dhis2:anc:uniqueId",
            value : getAttrByCode("ANC.A.DE1")
          }
        ],
        name : [
          {
            family : getAttrByCode("FAMILY_NAME"),
            given : [
              getAttrByCode("GIVEN_NAME")
            ]
          }
        ],
        contact: std.prune([
            if !ds.isEmpty(alternativeContact())
            then alternativeContact(),
            if !ds.isEmpty(ancContact())
            then ancContact(),
            if getAttrByCode("ANC.A.DE16") != null && getAttrByCode("ANC.A.DE16") == "true"
            then extendedFamilyContact(),
            if getAttrByCode("ANC.A.DE18") != null && getAttrByCode("ANC.A.DE18") == "true"
            then friendContact(),
            if getAttrByCode("ANC.A.DE14") != null && getAttrByCode("ANC.A.DE14") == "true"
            then parentContact(),
            if getAttrByCode("ANC.A.DE17") != null && getAttrByCode("ANC.A.DE17") == "true"
            then partnerContact(),
            if getAttrByCode("ANC.A.DE15") != null && getAttrByCode("ANC.A.DE15") == "true"
            then siblingContact()
        ]
        ),
        [if getAttrById("ciCR6BBvIT4") != null then "telecom"]: [
          {
            system: "phone",
            value: getAttrById("ciCR6BBvIT4")
          }
        ],
        gender : "female",
        birthDate : getAttrByCode("PATINFO_DOB"),
        address: getAttrByCode("ADDRESS")
      }, request: {
        method: "PUT",
        url: "Patient?identifier=urn:dhis2:anc:uniqueId|" + getAttrByCode("ANC.A.DE1")
      }
    }
  ] + (if getAttrByCode("ANC.A.DE9") != null && getAttrByCode("ANC.A.DE9") == "true"
       then [
    {
      resource: {
        resourceType : "Consent",
        patient: {
          reference: $.entry[0].fullUrl
        }
      }, request: {
        method: "PUT",
        url: "Consent?patient.identifier=urn:dhis2:anc:uniqueId|" + getAttrByCode("ANC.A.DE1")
      }
    }
  ]
       else if (getAttrByCode("ANC.A.DE9") != null && getAttrByCode("ANC.A.DE9") == "false") then [
    {
      request: {
        method: "DELETE",
        url: "Consent?patient.identifier=urn:dhis2:anc:uniqueId|" + getAttrByCode("ANC.A.DE1")
      }
    }
  ]         else [])
}