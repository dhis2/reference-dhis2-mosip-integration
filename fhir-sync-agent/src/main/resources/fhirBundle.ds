local patient = import 'patientResource.libsonnet';
local practitioner = import 'practitionerResource.libsonnet';
local encounter = import 'encounterResource.libsonnet';

local teiUpdatedBy = (body.updatedBy) default null;

local enrollments(tei) = (tei.enrollments) default [];
local enrollmentEvents(tei) = std.flattenArrays([ (en.events default []) for en in (tei.enrollments default []) ]);
local completedEvents(tei) = [
  ev
  for ev in enrollmentEvents(tei)
  if (ev.status default "") == "COMPLETED"
];

local entries(tei) = std.prune([
  patient.patient_entry(ds, tei),
  practitioner.practitioner_entry_from_user(ds, teiUpdatedBy)
])
+
[
  encounter.encounter_entry(ds, tei, event) for event in completedEvents(tei)
];

{
  resourceType: "Bundle",
  type: "transaction",
  entry: entries(body)
}