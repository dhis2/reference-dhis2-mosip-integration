"local getAttrById(attr) = ds.filter(body.enrollments[0].attributes, function(v, i) v.attribute == attr)[0].value default null;\r\nlocal getAttrByCode(attr) = ds.filter(body.enrollments[0].attributes, function(v, i) std.get(v, \"code\", \"\") == attr)[0].value default null;\r\n\r\nlocal alternativeContact() = {\r\n  [if getAttrByCode(\"ANC.A.DE10\") != null then \"name\"]: getAttrByCode(\"ANC.A.DE10\"),\r\n  [if getAttrByCode(\"ANC.A.DE11\") != null then \"telecom\"]: {\r\n    \"system\": \"phone\",\r\n    \"value\": getAttrByCode(\"ANC.A.DE11\")\r\n  }\r\n};\r\n\r\nlocal ancContact() = {\r\n  [if getAttrByCode(\"ANC.A.DE12\") != null then \"telecom\"]: {\r\n    system: \"phone\",\r\n    value: getAttrByCode(\"ANC.A.DE12\")\r\n  }\r\n};\r\n\r\nlocal extendedFamilyContact() = {\r\n  name: {\r\n    text: \"Extended family\"\r\n  },\r\n  relationship: [\r\n    {\r\n      coding: [\r\n        {\r\n          system : \"http:\/\/terminology.hl7.org\/CodeSystem\/v3-RoleCode\",\r\n          code: \"EXT\",\r\n          display: \"extended family member\"\r\n        }\r\n      ]\r\n    }\r\n  ]\r\n};\r\n\r\nlocal friendContact() = {\r\n  relationship: [\r\n    {\r\n      coding: [\r\n        {\r\n          system : \"http:\/\/terminology.hl7.org\/CodeSystem\/v3-RoleCode\",\r\n          code: \"FRND\",\r\n          display: \"friend\"\r\n        }\r\n      ]\r\n    }\r\n  ]\r\n};\r\n\r\nlocal parentContact() = {\r\n  relationship: [\r\n    {\r\n      coding: [\r\n        {\r\n          system : \"http:\/\/terminology.hl7.org\/CodeSystem\/v3-RoleCode\",\r\n          code: \"PRN\",\r\n          display: \"parent\"\r\n        }\r\n      ]\r\n    }\r\n  ]\r\n};\r\n\r\nlocal partnerContact() = {\r\n  relationship: [\r\n    {\r\n      coding: [\r\n        {\r\n          system : \"http:\/\/terminology.hl7.org\/CodeSystem\/v3-RoleCode\",\r\n          code: \"DOMPART\",\r\n          display: \"domestic partner\"\r\n        }\r\n      ]\r\n    }\r\n  ]\r\n};\r\n\r\nlocal siblingContact() = {\r\n  relationship: [\r\n    {\r\n      coding: [\r\n        {\r\n          system : \"http:\/\/terminology.hl7.org\/CodeSystem\/v3-RoleCode\",\r\n          code: \"SIB\",\r\n          display: \"sibling\"\r\n        }\r\n      ]\r\n    }\r\n  ]\r\n};\r\n\r\n{\r\n  resourceType: \"Bundle\",\r\n  type: \"transaction\",\r\n  entry: [\r\n    {\r\n      fullUrl: \"urn:uuid:ff991a8e-db1c-dfe2-e5b1-e411451eb602\",\r\n      resource: {\r\n        resourceType : \"Patient\",\r\n        meta : {\r\n          profile : [\r\n            \"http:\/\/hl7.org\/fhir\/uv\/ips\/StructureDefinition\/Patient-uv-ips\"\r\n          ]\r\n        },\r\n        identifier : [\r\n          {\r\n            system : \"urn:dhis2:anc:uniqueId\",\r\n            value : getAttrByCode(\"ANC.A.DE1\")\r\n          }\r\n        ],\r\n        name : [\r\n          {\r\n            family : getAttrByCode(\"FAMILY_NAME\"),\r\n            given : [\r\n              getAttrByCode(\"GIVEN_NAME\")\r\n            ]\r\n          }\r\n        ],\r\n        contact: std.prune([\r\n            if !ds.isEmpty(alternativeContact())\r\n            then alternativeContact(),\r\n            if !ds.isEmpty(ancContact())\r\n            then ancContact(),\r\n            if getAttrByCode(\"ANC.A.DE16\") != null && getAttrByCode(\"ANC.A.DE16\") == \"true\"\r\n            then extendedFamilyContact(),\r\n            if getAttrByCode(\"ANC.A.DE18\") != null && getAttrByCode(\"ANC.A.DE18\") == \"true\"\r\n            then friendContact(),\r\n            if getAttrByCode(\"ANC.A.DE14\") != null && getAttrByCode(\"ANC.A.DE14\") == \"true\"\r\n            then parentContact(),\r\n            if getAttrByCode(\"ANC.A.DE17\") != null && getAttrByCode(\"ANC.A.DE17\") == \"true\"\r\n            then partnerContact(),\r\n            if getAttrByCode(\"ANC.A.DE15\") != null && getAttrByCode(\"ANC.A.DE15\") == \"true\"\r\n            then siblingContact()\r\n        ]\r\n        ),\r\n        [if getAttrById(\"ciCR6BBvIT4\") != null then \"telecom\"]: [\r\n          {\r\n            system: \"phone\",\r\n            value: getAttrById(\"ciCR6BBvIT4\")\r\n          }\r\n        ],\r\n        gender : \"female\",\r\n        birthDate : getAttrByCode(\"PATINFO_DOB\"),\r\n        address: getAttrByCode(\"ADDRESS\")\r\n      }, request: {\r\n        method: \"PUT\",\r\n        url: \"Patient?identifier=urn:dhis2:anc:uniqueId|\" + getAttrByCode(\"ANC.A.DE1\")\r\n      }\r\n    }\r\n  ] + (if getAttrByCode(\"ANC.A.DE9\") != null && getAttrByCode(\"ANC.A.DE9\") == \"true\"\r\n       then [\r\n    {\r\n      resource: {\r\n        resourceType : \"Consent\",\r\n        patient: {\r\n          reference: $.entry[0].fullUrl\r\n        }\r\n      }, request: {\r\n        method: \"PUT\",\r\n        url: \"Consent?patient.identifier=urn:dhis2:anc:uniqueId|\" + getAttrByCode(\"ANC.A.DE1\")\r\n      }\r\n    }\r\n  ]\r\n       else if (getAttrByCode(\"ANC.A.DE9\") != null && getAttrByCode(\"ANC.A.DE9\") == \"false\") then [\r\n    {\r\n      request: {\r\n        method: \"DELETE\",\r\n        url: \"Consent?patient.identifier=urn:dhis2:anc:uniqueId|\" + getAttrByCode(\"ANC.A.DE1\")\r\n      }\r\n    }\r\n  ]         else [])\r\n}"